```mermaid   
stateDiagram-v2
    direction LR

    %% Начальное состояние
    [*] --> Ожидание : Система запущена

    %% Состояния
    state "Ожидание (Idle)" as Ожидание
    state "Ожидание оплаты" as ОжиданиеОплаты
    state "Деньги получены" as ДеньгиПолучены
    state "Билет выдан" as БилетВыдан
    state "Транзакция отменена" as ТранзакцияОтменена

    %% Переходы и триггеры

    %% 1. Пользователь выбрал билет
    Ожидание --> ОжиданиеОплаты : Выбор билета\n(SelectTicket)

    %% 2. Внесена достаточная сумма
    ОжиданиеОплаты --> ДеньгиПолучены : Внесена полная сумма\n(InsertMoney)

    %% 3. Выдача билета
    ДеньгиПолучены --> БилетВыдан : Выдать билет\n(DispenseTicket)

    %% 4. После получения билета — возврат в начальное состояние
    БилетВыдан --> Ожидание : Пользователь забрал билет\n(Транзакция завершена)

    %% 5. Отмена на любом этапе до выдачи
    ОжиданиеОплаты --> ТранзакцияОтменена : Отмена клиентом\n(CancelTransaction)
    ДеньгиПолучены --> ТранзакцияОтменена : Отмена клиентом\n(CancelTransaction)

    %% 6. После отмены — возврат в ожидание
    ТранзакцияОтменена --> Ожидание : Деньги возвращены\n(Готов к новому клиенту)

    %% Примечания
    note right of ТранзакцияОтменена
        Все внесённые деньги возвращаются
        Автомат переходит в режим ожидания
    end note

    note right of БилетВыдан
        Билет выдан
        Сдача (если есть) возвращена
    end note
```
